# Distributed Database - 分布式数据库

---

## 简介

分布式数据库管理系统将数据库划分在多个物理节点上。应用通常不需要意识到数据由哪些节点处理。分布式数据库管理系统能够提供容灾能力、更大的存储容量以及更高的并发量。分布式数据库管理系统和并行数据库系统的区别：

| 分布式数据库管理系统 | 并行数据库管理系统 |
| ---------- | --------- |
| 节点可能分布很远   | 节点分布近     |
| 节点间由公网连接   | 节点间由LAN连接 |
| 通信开销较大     | 通信开销较小    |
| 较高的系统可用性   | 较低的系统可用性  |

---

## 系统架构

数据库管理系统的架构指定了什么样的共享资源是CPU能够直接访问的。它影响着CPU在该数据库中的什么地方检索和存储数据以及CPU之间是如何协作的。应用广泛的架构是Shared-Disk和Shared-Nothing。

**Shared-Memory 架构** 所有的CPU共享同一个内存和一个磁盘。

**Shared-Disk 架构** 所有的CPU有独立的内存，但共享一个磁盘。该架构适用于不需要更高并行度而需要更高可用性的应用。与共享内存相比，其支持更多的处理器。另外，存储层和计算层都可以独立改变资源。其瓶颈是存储访问。

**Shared-Nothing 架构** 所有的CPU有独立的磁盘和内存。通过计算机网络通信。该架构的优点是具有更高的可扩展性、能够避免所有的IO都需要网络通信的情况。其缺点是，通信开销和非本地磁盘访问的开销。

---

## 设计问题

分布式数据库管理系统设计的关键问题是：

* 应用怎么发送查询？

* 查询怎么在分布的数据上执行？

* 系统怎么划分资源？

* 节点应该是同性质的还是不同性质的？

---

## 数据分割 (Data Partitioning)

分布式数据库管理系统把数据库划分在多个节点上的过程被称为数据分割。当关系很大的时候，数据分割能够最大化一个结点的事务，从而提高系统的并行能力。而对于小的关系，数据分割并不合适。

数据分割可以按照在元组层上的*水平分割* 和属性层上的*垂直分割* 进行。水平分割的常用策略包括：轮转分割(round-robin partitioning)、范围分割(range partitioning)，哈希分割(hash partitioning)。其中，哈希分割的一种扩展技术是一致哈希，其解决了基本的哈希分割存在的资源增减问题。

在数据分割中需要解决的关键问题是：如何保证数据分布均匀以及执行均衡。平衡的范围分割(Balanced range partition)和虚拟节点分割(virtual node partition)技术可以用来解决该问题。平衡的范围分割可以通过排序或者柱状图统计数据实现，但该技术的缺点是它只能处理静态的数据不均问题。而虚拟节点分割技术可以动态的解决数据和执行的负载均衡问题。

---

## 复制(Replication)

分布式数据库的一个目标就是提供高可用性，为实现这一目标，分布式数据库管理系统需要使用复制技术。复制技术的设计选择包括：

- K-安全：描述系统的可用性。其中的k值表示系统总是至少有k个结点可用。

- 复制配置：主从复制 OR 多主复制。在主从复制中，事务只能在数据主节点上更新。在多主复制中，事务可以在数据的任何节点上更新。

- 传播策略：异步(弱一致性、性能较高) OR 同步(强一致性、性能较低)

- 日志传播时间：连续(生成便传播) OR 在提交时

- 主被关系：主动-主动 OR 主动-被动。在主动-主动中，每个事务在每个结点上独立地进行，在事务结束时，需要检查每个结点的结果是否相同。该关系并不常用。在主动-被动关系中，事务在一个节点上进行，将产生的改变发送给其他结点。例如，Raft集群就采用这样的策略。

复制的并发控制技术包括：

- 主复制(primary copy)

- 多数协议(majority protocol)

- 偏见协议(biased protocol)

- 法定人数共识协议(quorum consensus protcol)

在使用复制技术还需要考虑处理故障。

---

## 并发控制(Concurrency Control)

分布式数据库管理系统的并发控制有两个方向：

* 中心化的协调者(centralized coordinator)

* 去中心化的协调者s(decentralized coordinator)

在单机数据库中使用的基于锁的协议和基于时间戳的协议均可稍作修改用于分布式数据库管理系统的并发控制。

---

## 分布式事务(Distributed Transaction)

访问位于多个节点上的数据的事务被称为分布式事务。在处理分布式事务的系统中，每个节点都有事务管理器(transaction manager)和事务协调者(transaction coordinator)这两个子系统。分布式事务需要解决消息丢失、通信链路故障、节点故障和网络分割的问题。

---

## 原子提交协议(Atomic Commit Protocol)

为确保事务的原子性，该事务执行所涉及到的所有节点都要对本次执行达成一致。通过原子提交协议来保证事务要么提交、要么中止。常用的协议包括：两阶段提交协议(2 Phase Commit)和分布式共识算法(Raft和Paxos)。

---

## 一致性问题(Consistency Issues)

CAP理论指出分布式系统无法同时是：Consistent, Available, Partition tolerant。

PACELC指出分布式系统在网络分割(Partition)的情况下，无法同时满足可用性(Availability)和一致性(Consistency)。在没有网络分割而正常工作的情况下(Else)，也需要在延迟(Latency)和一致性之(Consistency)间做出抉择。

---

## 执行模型(Execution Model)

分布式数据库管理系统的执行模型指定其在执行期间节点间是怎么通信的。有推查询到数据(Push a qeury to data)和拉数据到查询(Pull data to a query)。为处理查询执行期间数据库系统的故障，可能的技术是快照。大多数分布式OLAP数据库管理系统假定查询执行期间并不会出现故障。

---

## 查询计划(Query Plan)

分布式数据库管理系统中的查询优化可以使用单机数据库管理系统的优化技术，但还需要额外考虑数据的物理分布位置。有两种优化技术：1）分布物理算子到节点上（大多数分布式数据库系统选择的方法）；2）将SQL语句分片。

---

## 联合算法(Join Algorithm)

分布式数据库管理系统的联合算法的效率依赖于数据分割的策略。OLAP工作负载的数据库的大多数时间都花在联合操作上，联合算法的好坏影响系统的性能。Semi-Join是一种可以减少发送的数据量的联合算法。

---

## 云系统(Cloud System)

相关术语：DBaaS, Managed DBMS, Cloud-Native DBMS, Serverless Databases, Data Lakes.（介绍参考Lecture-note-23）
