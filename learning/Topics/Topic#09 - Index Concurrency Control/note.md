# 并发控制（Concurrency Control）

---

> 并发控制协议是数据库管理系统确保对共享对象进行并发操作的正确性的方法。并发控制协议需要保证逻辑正确性和物理正确性。

## 闩概述（Latchs Overview）

**锁(Lock)：** 在事务级上保护数据库的逻辑内容正确。在事务执行期间加锁。需要支持回滚操作。

**闩(Latch)：** 在线程级上保护数据库内部数据结构的关键区。在操作执行期间加闩。不需要支持回滚操作

闩有两读和写两种模式。可以通过操作系统的互斥锁和读写锁来实现闩。

---

## 哈希表闩（Hash Table Latching）

哈希表闩有表闩、页闩和槽点闩三种类型。表闩适合在对表进行大小改变的时候使用，并且不存在死锁问题。但并行性降低。

---

## B+树闩（B+ Tree Latching）

实现B+树并发控制协议需要关注的两个问题

* 允许多线程同时访问和更新B+树。

* 需要避免多个线程同时更新同一个节点以及当心一个线程在遍历树时，另一个线程正在分割/合并节点的情况。

**Crabbing Protocol:** 允许多个线程同时访问和更改B+树。规定：在遍历的过程中，先对父节点加闩，再对子节点加闩，如果父节点是安全(子节点不需要合并或者分割)的，那么释放父节点的闩。 

通过观察发现，一般情况下在Insert和Delete操作中对根节点加写闩会降低并发性并且分割和合并现象不常出现。因而，先在这两个操作遍历过程中先加读闩，如果会发生分割或合并，就重新遍历并加写闩。

---

## 叶节点扫描（Leaf Node Scans）

在范围处理操作中，会涉及到叶节点的扫描。

闩本身不提供对死锁的检测，所以死锁的避免需要由代码带保证。由于节点并不知道相邻节点具体在做什么而又要避免死锁，所以需要设置锁的等待时间，一旦超市，需要让等待线程自己结束。
